import React, {Fragment, useContext, useState} from "react";
import {Link, NavLink, Redirect} from "react-router-dom";

import Topbar from 'components/topbar'
import Footer from 'components/footer'
import {CurrentUserContext} from "contexts/currentUser";
import useLocalStorage from 'hooks/useLocalStorage';


/**
 * Контейнер который используется на всех страницах
 */
const Layout = ({children}) => {
    const [currentUserState, dispatch] = useContext(CurrentUserContext)
    const [, setToken] = useLocalStorage('token')
    const [isSuccessfulLogout, setIsSuccessfulLogout] = useState(false)
    const [isOpenMenu, setIsOpenMenu] = useState(false)
    const [isOpenBtn, setIsOpenBtn] = useState(false)
    const openMenu = () => {
        let el = document.getElementById('mobile-btn');
        let myNavbar = document.getElementById('myNavbar');
        if(!isOpenMenu){
            setIsOpenMenu(true)
            el.classList.toggle('collapsed');
            el.setAttribute('aria-expanded', 'true')
            myNavbar.classList.toggle("in");
            myNavbar.setAttribute("style", "1.97917px")
        } else {
            el.classList.toggle('collapsed');
            el.setAttribute('aria-expanded', 'false')
            myNavbar.classList.toggle("in");
            myNavbar.setAttribute("style", "")
        }
    }
    const openBtn = () => {
        let el1 = document.getElementById('entrBtn');
        let el2 = document.getElementById('level');
        if(!isOpenBtn){
            setIsOpenBtn(true)
            el1.classList.toggle("minus")
            el2.style.display = "block"
        } else {
            el1.classList.toggle("minus")
            el2.style.display = "none"
        }
    }

    const logout = event => {
        event.preventDefault()
        setToken('')
        dispatch({type: 'LOGOUT'})
        setIsSuccessfulLogout(true)
    }

    if(isSuccessfulLogout){
        document.location.reload()
        return <Redirect to='/'/>
    }

    return (
        <div>
            <header id="header" className="header-v1">
                <div className="sticky-header text-center hidden-xs hidden-sm">
                    <div className="text">
                        <span className="u-line"><a href="mailto:zapovednik@bk.ru">zapovednik@bk.ru</a></span> или
                        позвоните нам +7(495)229-8520
                    </div>
                </div>
                <Topbar/>
                <div className="header-top">
                    <div className="container container-40">
                        <div className="row">
                            <div className="col-xs-12 col-sm-12 col-md-12">

                                <div className="logo-mobile hidden-lg hidden-md">
                                    <Link to="/" title="home-logo">
                                        <img src="/img/main/aqualogo.png"
                                             alt="logo"
                                             className="img-reponsive"
                                        />
                                    </Link>
                                </div>
                                <button type="button"
                                        className="navbar-toggle icon-mobile collapsed"
                                        data-toggle="collapse"
                                        data-target="#myNavbar"
                                        aria-expanded="false"
                                        id="mobile-btn"
                                        onClick={openMenu}
                                >
                                    <span className="icon-menu"></span>
                                </button>
                                <nav className="navbar main-menu" >
                                    <div className="collapse navbar-collapse" id="myNavbar">
                                        <ul className="nav navbar-nav js-menubar">
                                            <li className="level1 active dropdown">
                                                <NavLink to="/" className='nav-link'>Главная</NavLink>
                                            </li>
                                            <li className="level1 dropdown hassub">
                                                <NavLink to="/basket" className='nav-link'>Корзина</NavLink>
                                            </li>
                                            <li className="level1 active dropdown">
                                               {!currentUserState.isLoggedIn && (
                                                   <Fragment>
                                                     <a onClick={openBtn}>Вход</a>
                                                       <span className="plus js-plus-icon"
                                                             id="entrBtn"
                                                             onClick={openBtn}
                                                       ></span>
                                                         <ul className="dropdown-menu menu-level-1" id="level" style={{display: "none"}}>
                                                           <li className="level2">
                                                             <NavLink to="/login" title="Login" className='nav-link'>
                                                                Вход
                                                             </NavLink>
                                                           </li>
                                                           <li className="level2">
                                                              <NavLink to="/register" title="Register" className='nav-link'>
                                                                 Регистрация
                                                              </NavLink>
                                                           </li>
                                                         </ul>
                                                   </Fragment>)}
                                                {currentUserState.isLoggedIn && <a onClick={logout}>Выход</a>}

                                            </li>
                                            <li className="level1 dropdown hassub">
                                                <NavLink to="/delivery" className='nav-link'>Доставка</NavLink>
                                            </li>
                                            <li className="level1 active dropdown">
                                                <NavLink to="/payment" className='nav-link'>Оплата</NavLink>
                                            </li>
                                            <li className="level1 active dropdown">
                                                <NavLink to="/about" className='nav-link'>О нас</NavLink>
                                            </li>
                                        </ul>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            {children}
            <Footer/>
            {/*<Link to="#" className="scroll_top" onClick={window.scroll(0,0)}>SCROLL TO TOP<span></span></Link>*/}
        </div>
    )
}

export default Layout;