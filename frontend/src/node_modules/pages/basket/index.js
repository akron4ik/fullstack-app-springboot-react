import React, {useContext, useEffect} from "react";
import * as R from 'ramda';
import {Link} from "react-router-dom";

import Layout from 'conteiners/layout';
import {
    getBasketProductsWithCount,
    removeProductFromBasket,
    addProductToBasket,
    removeItemFromBasket,
    cleanBasket,
    countOfProduct,
    productSubPrice,
    getTotalPrice, getIds} from 'utils'
import {CurrentBasketContext} from 'contexts/currentBasket'
import useLocalStorage from "hooks/useLocalStorage";


/**
 * Страница Корзина
 */
const Basket = () => {
    const [currentBasketState, dispatch] = useContext(CurrentBasketContext)
    const products = getBasketProductsWithCount(currentBasketState)
    const isBasketEmpty = R.isEmpty(products);
    const [, setProd] = useLocalStorage('productsIds')

    useEffect(() => {
        if(currentBasketState.length === 0){
            setProd('');
            return
        }
        setProd(getIds(currentBasketState))
    }, [currentBasketState, setProd])

    const renderContent = () => (
            <div>
                {isBasketEmpty && <div>
                    <div className="main-content text-center empty-cart-content space-padding-tb-60">
                        <div className="container">
                            <span className="close-empty-cart"></span>
                            <h3>Ваша корзина пуста</h3>
                            <Link to="/" className="bordersolid-2 btn-return">В магазин
                                <span className="icon-arr"></span></Link>
                        </div>
                    </div>
                </div>}
                <div className="container">
                <div className="row">
                <div className="col-md-8">
                    {R.not(isBasketEmpty) && <h3>Корзина покупок</h3>}
                    <table className="table cart-table space-30">
                        <tbody>
                        {products.map((product, index) =>(
                            <tr className="item_cart" key={index}>
                                <td className="product-photo" ><img src={product.image} alt="Futurelife"/></td>
                                <td className="produc-name"><a title="">{product.name}</a>
                                    <div className="quantity input-group">
                                        <button type="button" className="quantity-left-minus btn btn-number js-minus"
                                                data-type="minus">
                                            <span className="minus-icon" onClick={() => removeItemFromBasket(product, dispatch)}>-</span>
                                        </button>
                                        <a className=" js-number"> &nbsp;{countOfProduct(product, currentBasketState)} &nbsp;</a>
                                        <button type="button" className="quantity-right-plus btn btn-number js-plus"
                                                data-type="plus">
                                            <span className="plus-icon" onClick={() => addProductToBasket(product, dispatch)}>+</span>
                                        </button>
                                    </div>
                                </td>
                                <td className="total-price">
                                    <a className="remove" title="" onClick={()=> removeProductFromBasket(product, dispatch)} >x</a>
                                    <p className="price">{productSubPrice(product, currentBasketState)} руб.</p>
                                </td>
                            </tr>
                           ))}
                        </tbody>
                    </table>
                    {R.not(isBasketEmpty) && <div className="row">
                        <div className="col-xs-12 col-sm-6">
                            <Link to="/" className="btn link-button hover-black continue">Вернуться в магазин</Link>
                        </div>
                        <div className="col-xs-12 col-sm-6">
                            <a className="btn link-button hover-black update" onClick={()=>  cleanBasket(dispatch)}>Очистить корзину</a>
                        </div>
                    </div>}

                </div>
                    {R.not(isBasketEmpty) &&
                    <div className="col-md-4">
                        <h3>Информация о заказе</h3>
                        <div className="text-price">
                            <ul>
                                <li><span className="text">Общая сумма: </span><span className="number">{getTotalPrice(currentBasketState)} руб.</span></li>
                            </ul>
                        </div>
                        <Link className="btn link-button hover-white checkout" to="/checkout" title="Proceed to checkout" >Оформить заказ</Link>

                    </div>}
                </div>
                </div>

            </div>
        )


        return(
            <Layout>
                <br></br>
                {renderContent()}
                <br></br>
            </Layout>
        )

}

export default Basket;