import {useContext, useEffect} from 'react'

import useFetch from 'hooks/useFetch'
import {CurrentBasketContext} from 'contexts/currentBasket'
import useLocalStorage from 'hooks/useLocalStorage'
import {ADD_ALL_TO_BASKET} from 'actionTypes'
import {parseStringToArray} from 'utils'

/**
 * Чекер для корзины, для того чтобы при обновлении страницы данные корзины не терялись
 */
const CurrentBasketChecker = ({children}) => {
    const [, dispatch] = useContext(CurrentBasketContext)
    const [{response}, doFetch] = useFetch(`/rest/products/cart`)
    const [productIds] = useLocalStorage('productsIds')
    const array = parseStringToArray(productIds);

    useEffect(() => {
        if(!productIds) {
            return
        }
        doFetch({
            method: 'post',
            data: array
        })

    }, [productIds, doFetch, array])

    useEffect(() => {
        if(!response){
            return
        }
        dispatch({type: ADD_ALL_TO_BASKET, payload: response})
    }, [response, dispatch])
    return children
}

export default CurrentBasketChecker